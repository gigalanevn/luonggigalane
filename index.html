<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Phi·∫øu L∆∞∆°ng Gigalane</title>
    <style>
        :root { 
            --blue-main: #1a73e8; 
            --blue-focus: #007bff; /* M√†u xanh khi nh·∫•n v√†o */
            --orange-border: #ff9800; 
            --blue-light: #e3f2fd; 
            --yellow-sum: #fff9c4;
            --border-black: #000000;
        }
        body { font-family: 'Segoe UI', Tahoma, sans-serif; padding: 10px; background: #f8f9fa; margin: 0; }
        .container { background: white; padding: 10px; max-width: 1400px; margin: 0 auto; border: 1px solid #ccc; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        
        .main-header-title {
            text-align: center; color: #b71c1c; font-size: 22px; font-weight: bold;
            margin-bottom: 15px; text-transform: uppercase; border-bottom: 2px solid #b71c1c; padding-bottom: 5px;
        }

        /* --- HI·ªÜU ·ª®NG VI·ªÄN XANH KHI NH·∫§N V√ÄO (FOCUS) --- */
        /* √Åp d·ª•ng cho t·∫•t c·∫£ input v√† select */
        input:focus, select:focus {
            outline: none !important;
            border: 2px solid var(--blue-focus) !important; /* Vi·ªÅn chuy·ªÉn xanh */
            background-color: #ffffff !important; /* Gi·ªØ nguy√™n n·ªÅn tr·∫Øng */
            box-shadow: 0 0 5px rgba(0, 123, 255, 0.5); /* Hi·ªáu ·ª©ng ƒë·ªï b√≥ng vi·ªÅn */
        }

        .header-top { display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; margin-bottom: 10px; gap: 10px; border-bottom: 1px solid #ddd; padding-bottom: 10px; }
        .header-left { display: flex; align-items: center; gap: 10px; flex-wrap: wrap; }
        
        .top-final-box { background: var(--blue-light); border: 2px solid var(--blue-main); padding: 8px 15px; border-radius: 8px; display: flex; align-items: center; }
        .top-final-label { color: #0d47a1; font-weight: bold; font-size: 15px; margin-right: 10px; }
        .top-final-val { color: #b71c1c; font-size: 26px; font-weight: bold; }

        .guide-box { background: #fff3e0; border-left: 4px solid #ff9800; padding: 10px; margin-bottom: 10px; font-size: 12px; color: #5d4037; line-height: 1.4; }

        .storage-bar { background: #f1f3f4; padding: 8px; border-radius: 8px; margin-bottom: 10px; display: flex; align-items: center; gap: 8px; flex-wrap: wrap; border: 1px solid #ddd; font-size: 13px; }
        .btn-save { background: #28a745; color: white; border: none; padding: 6px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; }
        
        .input-name { border: none; border-bottom: 2px solid var(--border-black); font-weight: bold; color: var(--blue-main); padding: 5px; font-size: 16px; width: 150px; outline: none; background: transparent; text-transform: uppercase; }
        /* Ri√™ng √¥ t√™n ch·ªâ ƒë·ªïi m√†u g·∫°ch ch√¢n */
        .input-name:focus { border-bottom: 2.5px solid var(--blue-focus) !important; box-shadow: none; }

        .select-date { border: 2px solid var(--orange-border); border-radius: 4px; padding: 4px; font-weight: bold; background: white; }

        .info-bar { display: flex; align-items: center; gap: 12px; border: 2px solid var(--blue-main); border-radius: 8px; padding: 8px; margin-bottom: 10px; background: #fff; flex-wrap: wrap; font-size: 11px; font-weight: bold; }
        .input-small { width: 40px !important; text-align: center; padding: 4px !important; border: 1px solid var(--orange-border) !important; border-radius: 4px; }

        /* C√°c √¥ nh·∫≠p li·ªáu ch√≠nh */
        input[type="text"]:not(.input-name):not(.input-small) { 
            border: 2px solid var(--orange-border);
            border-radius: 4px; padding: 6px; font-size: 14px; 
            background-color: #ffffff; color: #000; box-sizing: border-box;
            width: 100%; transition: border 0.2s;
        }

        table { width: 100%; border-collapse: collapse; margin-bottom: 10px; table-layout: fixed; }
        th, td { border: 1px solid #888; padding: 5px; text-align: center; font-size: 11px; }
        .section-head { background: #e8f0fe !important; color: var(--blue-main); font-weight: bold; height: 30px; }
        .col-gray { background: #f1f3f4; font-weight: bold; }
        .col-sum { background: var(--yellow-sum) !important; font-weight: bold; color: #d32f2f; }

        @media screen and (orientation: portrait) {
            table, thead, tbody, th, td, tr { display: block; width: 100%; }
            thead tr:not(.section-head) { display: none; }
            tr { border: 2px solid #aaa; margin-bottom: 10px; border-radius: 8px; overflow: hidden; }
            td { display: flex; align-items: center; min-height: 50px; border: none !important; border-bottom: 1px solid #eee !important; padding: 0 !important; }
            .m-lbl { width: 40%; background: #f0f0f0; padding-left: 10px; font-weight: bold; height: 50px; display: flex; align-items: center; font-size: 10px; border-right: 1px solid #888; text-align: left; flex-shrink: 0; }
            .input-wrap { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: flex-end; padding-right: 8px; overflow: hidden; }
            input:not(.chk-box):not(.input-name):not(.input-small) { width: 95% !important; text-align: right !important; height: 32px; }
            .res-val { color: #28a745; font-weight: bold; font-size: 10px; margin-top: 2px; }
        }
    </style>
</head>
<body>

<div class="container">
   <!--  <div style="text-align: right; margin-bottom: 5px;">
        <a href="https://s.shopee.vn/AAAUhiQ8ae" target="_blank" style="text-decoration: none; color: #1a73e8; font-weight: bold; font-size: 13px;">
            Nh·∫•n v√†o ƒë√¢y (link shoppe) khi c√≥ nhu c·∫ßu mua h√†ng tr√™n shoppe (·∫•n v√†o, t√¨m th·ª© c·∫ßn mua v√† mua h√†ng) ƒë·ªÉ ·ªßng h·ªô ng∆∞·ªùi l√†m phi·∫øu l∆∞∆°ng, xin c·∫£m ∆°n!
        </a>
    </div> -->
    <div class="main-header-title">PHI·∫æU L∆Ø∆†NG GIGALANE</div>

    <div class="guide-box">
        <b>üí° H∆∞·ªõng d·∫´n:</b> 1. Ch·ªçn <b>Th√°ng/NƒÉm</b> , nh·∫≠p s·ªë <b>c√¥ng th·ª±c t·∫ø</b> | 2. M·ª•c 1 Nh·∫≠p l∆∞∆°ng v√† tr·ª£ c·∫•p (ch·ªâ nh·∫≠p l·∫ßn ƒë·∫ßu) | 3. M·ª•c 2 nh·∫≠p c√°c kho·∫£n thu, n·∫øu l√† <b>NAM</b> b·ªè tick PN·ªØ | 4. Nh·∫≠p s·ªë <b>gi·ªù</b> tƒÉng ca (n·∫øu l·∫ª d√πng d·∫•u <b>.</b> v√≠ d·ª• 10.5 ) | 5. Nh·∫•n <b>L∆∞u</b> ƒë·ªÉ l∆∞u v√†o l·ªãch s·ª≠.
    </div>

    <div class="header-top">
        <div class="header-left">
            <div><label>H·ªå T√äN:</label> <input type="text" id="userName" placeholder="NH·∫¨P T√äN..." class="input-name save" oninput="load()"></div>
            <div>
                <!-- <select id="selMonth" class="select-date save" onchange="updateCongChuan(); load();"> -->
                    <select id="selMonth" class="select-date save" onchange="load()">
                    <script>for(let i=1; i<=12; i++) document.write(`<option value="${i}">Th√°ng ${i}</option>`)</script>
                </select>
                    <!-- <select id="selYear" class="select-date save" onchange="document.getElementById('show_year_total').checked = false; toggleYearTotal(); updateCongChuan(); load();"> -->
                        <!-- <select id="selYear" class="select-date save" onchange="document.getElementById('show_year_total').checked = false; updateCongChuan(); load(); calculateYearTotal();"> -->
            <!-- <select id="selYear" class="select-date save" onchange="document.getElementById('show_year_total').checked = false; toggleYearTotal(); updateCongChuan(); document.getElementById('historySelect').value='current'; load();"> -->
                <select id="selYear" class="select-date save" onchange="load()">
                    <script>for(let i=2025; i<=2035; i++) document.write(`<option value="${i}">NƒÉm ${i}</option>`)</script>
                </select>
            </div>
        </div>
        <div class="top-final-box">
            <span class="top-final-label">TH·ª∞C Lƒ®NH:</span>

            <span class="top-final-val" id="final_total_top">0</span>

        </div>
  <div class="top-final-box" style="margin-left: 10px; border-color: #28a745; display: flex; align-items: center; gap: 8px;">
    <input type="checkbox" id="show_year_total" onchange="toggleYearTotal()" style="width: 18px; height: 18px; cursor: pointer;">
    
    <div id="year_total_content" style="display: none; align-items: center;">
        <span class="top-final-label" style="color: #1b5e20; font-size: 14px; margin-right: 5px;">T·ªîNG TH·ª∞C NH·∫¨N C·∫¢ NƒÇM:</span>
        <span class="top-final-val" id="year_total" style="color: #2e7d32; font-size: 22px;">0</span>
    </div>
    
    <span id="year_total_placeholder" style="color: #666; font-size: 12px; font-style: italic;">Hi·ªán t·ªïng th·ª±c nh·∫≠n c·∫£ nƒÉm</span>
</div>
    </div>

    <div class="storage-bar">
        <b>L·ªãch s·ª≠:</b>
        <select id="historySelect" onchange="loadMonthlyData()">
            <option value="current">-- ƒêang nh·∫≠p --</option>
        </select>
        <button class="btn-save" onclick="saveMonthlyData()">L∆∞u Phi·∫øu Th√°ng N√†y</button>
        <button onclick="deleteMonthlyData()" style="background: #dc3545; color: white; border: none; padding: 6px 15px; border-radius: 4px; cursor: pointer; font-weight: bold; margin-left: 5px;">Xo√° Phi·∫øu Th√°ng N√†y</button>
    </div>
    
    <div class="info-bar">
        <div>C√¥ng t√≠nh tƒÉng ca: <input type="text" id="soCongChuan" value="26" class="save only-num-dot input-small" readonly style="background-color: #eee; cursor: not-allowed;"></div>
        <div>C√¥ng th·ª±c t·∫ø: <input type="text" id="soNgayGio" value="26" class="save only-num-dot input-small"></div>
        <div>L∆∞∆°ng ng√†y c√¥ng: <span id="r_ngaycong" style="color:var(--blue-main)">0</span></div>
        <div>T·ªïng ph·ª• c·∫•p: <span id="top_tongPC" style="color:var(--blue-main)">0</span></div>
        <div>L∆∞∆°ng t√≠nh tƒÉng ca: <span id="top_luongTC" style="color:var(--blue-main)">0</span></div>
    </div>

    <table>
        <thead>
            <tr class="section-head"><th colspan="12">1. TH√îNG TIN L∆Ø∆†NG</th></tr>
            <tr class="col-gray">
                <th>L∆∞∆°ng CB</th><th>Ch·ª©c v·ª•</th><th>K·ªπ nƒÉng</th><th>ATVSV</th><th>PCCC</th><th>Soi k√≠nh</th><th>Th√¢m ni√™n</th><th>ƒêT</th><th>Nh√† ·ªü</th><th>ƒêi l·∫°i</th><th>C.C·∫ßn</th><th class="col-sum">T·ªïng l∆∞∆°ng</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><div class="m-lbl">L∆∞∆°ng CB</div><div class="input-wrap"><input type="text" class="money save only-num" id="luongCB"><span class="res-val" id="r_luongCB"></span></div></td>
                <td><div class="m-lbl">Ch·ª©c v·ª•</div><div class="input-wrap"><input type="text" class="money save only-num" id="pccv"><span class="res-val" id="r_pccv"></span></div></td>
                <td><div class="m-lbl">K·ªπ nƒÉng</div><div class="input-wrap"><input type="text" class="money save only-num" id="pckn"><span class="res-val" id="r_pckn"></span></div></td>
                <td><div class="m-lbl">ATVSV</div><div class="input-wrap"><input type="text" class="money save only-num" id="pcat"><span class="res-val" id="r_pcat"></span></div></td>
                <td><div class="m-lbl">PCCC</div><div class="input-wrap"><input type="text" class="money save only-num" id="pcpccc"><span class="res-val" id="r_pcpccc"></span></div></td>
                <td><div class="m-lbl">Soi k√≠nh</div><div class="input-wrap"><input type="text" class="money save only-num" id="pcsk"><span class="res-val" id="r_pcsk"></span></div></td>
                <td><div class="m-lbl">Th√¢m ni√™n</div><div class="input-wrap"><input type="text" class="money save only-num" id="pctn"><span class="res-val" id="r_pctn"></span></div></td>
                <td><div class="m-lbl">ƒêT</div><div class="input-wrap"><input type="text" class="money save only-num" id="pcdt"><span class="res-val" id="r_pcdt"></span></div></td>
                <td><div class="m-lbl">Nh√† ·ªü</div><div class="input-wrap"><input type="text" class="money save only-num" id="pcno"><span class="res-val" id="r_pcno"></span></div></td>
                <td><div class="m-lbl">ƒêi l·∫°i</div><div class="input-wrap"><input type="text" class="money save only-num" id="pcdl"><span class="res-val" id="r_pcdl"></span></div></td>
                <td><div class="m-lbl">C.C·∫ßn</div><div class="input-wrap"><input type="text" class="money save only-num" id="pccc"><span class="res-val" id="r_pccc"></span></div></td>
                <td class="col-sum"><div class="m-lbl">  </div><span id="tong1Full" style="font-weight:bold">0</span></td>
            </tr>
        </tbody>
    </table>

    <table>
        <thead>
            <tr class="section-head"><th colspan="10">2. KHO·∫¢N THU KH√ÅC</th></tr>
            <tr class="col-gray">
                <th>Th∆∞·ªüng</th><th>Tr·∫ª nh·ªè</th><th>Ph√©p t·ªìn</th><th>ƒê/C L∆∞∆°ng</th><th>Th∆∞·ªüng ƒêA</th><th>Th∆∞·ªüng kh√°c</th><th>PC ƒÇn</th><th>PC H·ªì s∆°</th><th>PN·ªØ</th><th class="col-sum">T·ªïng kho·∫£n thu kh√°c</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><div class="m-lbl">Th∆∞·ªüng</div><div class="input-wrap"><input type="text" class="money save only-num" id="tk"></div></td>
                <td><div class="m-lbl">Tr·∫ª nh·ªè</div><div class="input-wrap"><input type="text" class="money save only-num" id="trenho"></div></td>
                <td><div class="m-lbl">Ph√©p t·ªìn</div><div class="input-wrap"><input type="text" class="money save only-num" id="phepton"></div></td>
                <td><div class="m-lbl">ƒê/C L∆∞∆°ng</div><div class="input-wrap"><input type="text" class="money save only-num" id="dcluong"></div></td>
                <td><div class="m-lbl">Th∆∞·ªüng ƒêA</div><div class="input-wrap"><input type="text" class="money save only-num" id="th_da"></div></td>
                <td><div class="m-lbl">Th∆∞·ªüng kh√°c</div><div class="input-wrap"><input type="text" class="money save only-num" id="th_khac"></div></td>
                <td><div class="m-lbl">B·ªØa ƒÉn</div><div class="input-wrap"><input type="text" class="money save only-num" id="pc_an"></div></td>
                <td><div class="m-lbl">H·ªì s∆°</div><div class="input-wrap"><input type="text" class="money save only-num" id="pc_hoso"></div></td>
                <td><div class="m-lbl">Ph·ª• n·ªØ</div><div class="input-wrap"><input type="checkbox" id="chk_pnu" class="save chk-box" onchange="calculateAll()" checked><span class="res-val" id="res_pnu">0</span></div></td>
                <td class="col-sum"><div class="m-lbl">  </div><span id="tong2" style="font-weight:bold">0</span></td>
            </tr>
        </tbody>
    </table>

    <table>
        <thead>
            <tr class="section-head"><th colspan="8">3. TƒÇNG CA (NH·∫¨P S·ªê GI·ªú)</th></tr>
            <tr class="col-gray">
                <th>150%</th><th>ƒê√™m 200%</th><th>22h 210%</th><th>CN 200%</th><th>ƒê√™m CN 270%</th><th>L·ªÖ 300%</th><th>ƒê√™m L·ªÖ 390%</th><th class="col-sum">T·ªïng tƒÉng ca</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><div class="m-lbl">150%</div><div class="input-wrap"><input type="text" class="save only-num-dot" id="g150"><span class="res-val" id="t150"></span></div></td>
                <td><div class="m-lbl">ƒê√™m 200%</div><div class="input-wrap"><input type="text" class="save only-num-dot" id="g200"><span class="res-val" id="t200"></span></div></td>
                <td><div class="m-lbl">Sau 22h</div><div class="input-wrap"><input type="text" class="save only-num-dot" id="g210"><span class="res-val" id="t210"></span></div></td>
                <td><div class="m-lbl">CN 200%</div><div class="input-wrap"><input type="text" class="save only-num-dot" id="g200cn"><span class="res-val" id="t200cn"></span></div></td>
                <td><div class="m-lbl">ƒê√™m CN</div><div class="input-wrap"><input type="text" class="save only-num-dot" id="g270"><span class="res-val" id="t270"></span></div></td>
                <td><div class="m-lbl">L·ªÖ 300%</div><div class="input-wrap"><input type="text" class="save only-num-dot" id="g300"><span class="res-val" id="t300"></span></div></td>
                <td><div class="m-lbl">ƒê√™m L·ªÖ</div><div class="input-wrap"><input type="text" class="save only-num-dot" id="g390"><span class="res-val" id="t390"></span></div></td>
                <td class="col-sum"><div class="m-lbl"> </div><span id="tong3" style="font-weight:bold">0</span></td>
            </tr>
        </tbody>
    </table>

    <table>
        <thead>
            <tr class="section-head"><th colspan="4">4. GI·∫¢M TR·ª™</th></tr>
            <tr class="col-gray">
                <th>BHXH (10.5%)</th><th>C√¥ng ƒëo√†n</th><th>Tr·ª´ kh√°c</th><th class="col-sum">C√°c kho·∫£n tr·ª´</th>
            </tr>
        </thead>
        <tbody>
            <tr>
                <td><div class="m-lbl">BHXH</div><div class="input-wrap" id="bhxh" style="color:red; font-weight:bold">0</div></td>
                <td><div class="m-lbl">C√¥ng ƒëo√†n</div><div class="input-wrap">30,000</div></td>
                <td><div class="m-lbl">Tr·ª´ kh√°c</div><div class="input-wrap"><input type="text" class="money save only-num" id="trukhac" style="color:red"></div></td>
                <td class="col-sum"><div class="m-lbl"></div><span id="tong4" style="font-weight:bold">0</span></td>
            </tr>
        </tbody>
    </table>
</div>
<div style="margin-top: 20px; padding: 15px; background: #fffde7; border: 2px dashed #fbc02d; border-radius: 10px; text-align: center;">
    <span style="font-size: 16px; font-weight: bold; color: #333;">T·ªîNG TH·ª∞C Lƒ®NH TH√ÅNG <span id="footer_month">...</span>:</span>
    <div id="final_total_footer" style="font-size: 35px; font-weight: bold; color: #b71c1c; margin-top: 5px;">0</div>
    <!-- <div style="font-size: 12px; color: #777; font-style: italic;">(Vui l√≤ng ki·ªÉm tra k·ªπ c√°c kho·∫£n tr∆∞·ªõc khi l∆∞u)</div> -->
</div>
<div style="text-align: center; margin-top: 20px; font-size: 13px; color: #666;">
    üëÅÔ∏è Visit: <span id="visit_count">...</span>
</div>
<script>
    document.getElementById('userName').addEventListener('input', function() {
    this.style.borderBottom = "2.5px solid var(--blue-focus)";
});

    const STORAGE_KEY_HISTORY = 'gigalane_history_data_v6';
    function fN(n) { return Math.round(n).toString().replace(/\B(?=(\d{3})+(?!\d))/g, ","); }
    function gV(id) { let el = document.getElementById(id); return el ? parseFloat(el.value.replace(/,/g,'')) || 0 : 0; }

function updateCongChuan() {
    const month = parseInt(document.getElementById('selMonth').value);
    const year = parseInt(document.getElementById('selYear').value);
    
    // T√≠nh t·ªïng s·ªë ng√†y trong th√°ng
    let totalDays = new Date(year, month, 0).getDate();
    let countWorkDays = 0;

    // ƒê·∫øm c√°c ng√†y kh√¥ng ph·∫£i Ch·ªß Nh·∫≠t
    for (let d = 1; d <= totalDays; d++) {
        let dayOfWeek = new Date(year, month - 1, d).getDay();
        if (dayOfWeek !== 0) { // 0 l√† Ch·ªß Nh·∫≠t
            countWorkDays++;
        }
    }

    // Quy t·∫Øc: N·∫øu > 26 th√¨ l·∫•y 26, n·∫øu nh·ªè h∆°n th√¨ l·∫•y th·ª±c t·∫ø
    let finalCongChuan = countWorkDays > 26 ? 26 : countWorkDays;
    
    // C·∫≠p nh·∫≠t v√†o √¥ input
    document.getElementById('soCongChuan').value = finalCongChuan;
}

    function calculateAll() {
        const chuan = gV('soCongChuan') || 26;
        const thuc = gV('soNgayGio');
        const tile = thuc / chuan;
        let lcb = gV('luongCB');
        let t1_Full = 0, t1_ThucTe = 0, t1_PC_ThucTe = 0;
        const list1 = ['luongCB','pccv','pckn','pcat','pcpccc','pcsk','pctn','pcdt','pcno','pcdl','pccc'];
        list1.forEach(id => {
            let val = gV(id); t1_Full += val;
            let val_thuc = val * tile; t1_ThucTe += val_thuc;
            if(id !== 'luongCB') t1_PC_ThucTe += val_thuc;
            if(document.getElementById('r_'+id)) document.getElementById('r_'+id).innerText = fN(val_thuc);
        });
        document.getElementById('tong1Full').innerText = fN(t1_Full);
        document.getElementById('r_ngaycong').innerText = fN(lcb * tile);
        document.getElementById('top_tongPC').innerText = fN(t1_PC_ThucTe);
        const luongTC = lcb + gV('pccv') + gV('pckn') + gV('pctn') + gV('pcsk') + gV('pcno');
        const gioTC = luongTC / chuan / 8;
        document.getElementById('top_luongTC').innerText = fN(luongTC);
        const tcs = [{id:'g150',h:1.5,r:'t150'},{id:'g200',h:2,r:'t200'},{id:'g210',h:2.1,r:'t210'},{id:'g200cn',h:2,r:'t200cn'},{id:'g270',h:2.7,r:'t270'},{id:'g300',h:3,r:'t300'},{id:'g390',h:3.9,r:'t390'}];
        let t3 = 0;
        tcs.forEach(x => {
            let money = gV(x.id) * gioTC * x.h;
            document.getElementById(x.r).innerText = fN(money);
            t3 += money;
        });
        document.getElementById('tong3').innerText = fN(t3);
        let pnu = document.getElementById('chk_pnu').checked ? (gioTC * 2.25) : 0;
        document.getElementById('res_pnu').innerText = fN(pnu);
        let t2 = pnu + gV('tk') + gV('trenho') + gV('phepton') + gV('dcluong') + gV('th_da') + gV('th_khac') + gV('pc_an') + gV('pc_hoso');
        document.getElementById('tong2').innerText = fN(t2);
        const bh = (lcb + gV('pccv') + gV('pckn') + gV('pctn') + gV('pcsk')) * 0.105;
        document.getElementById('bhxh').innerText = fN(bh);
        let t4 = bh + 30000 + gV('trukhac');
        document.getElementById('tong4').innerText = fN(t4);
        document.getElementById('final_total_top').innerText = fN(t1_ThucTe + t2 + t3 - t4);
        // C·∫≠p nh·∫≠t s·ªë ti·ªÅn xu·ªëng d∆∞·ªõi ch√¢n trang
document.getElementById('final_total_footer').innerText = fN(t1_ThucTe + t2 + t3 - t4);

// C·∫≠p nh·∫≠t s·ªë th√°ng hi·ªÉn th·ªã d∆∞·ªõi ch√¢n trang
document.getElementById('footer_month').innerText = document.getElementById('selMonth').value;
        save();
    }

function saveMonthlyData() {
    // 1. L·∫•y t√™n v√† ki·ªÉm tra
    const userNameInput = document.getElementById('userName');
    const name = userNameInput.value.trim();

    if (!name) {
        alert("‚ö†Ô∏è VUI L√íNG NH·∫¨P H·ªå T√äN TR∆Ø·ªöC KHI L∆ØU!");
        userNameInput.focus(); // T·ª± ƒë·ªông ƒë∆∞a con tr·ªè chu·ªôt v√†o √¥ t√™n
        userNameInput.style.border = "2px solid red"; // B√¥i ƒë·ªè √¥ t√™n ƒë·ªÉ nh·∫Øc nh·ªü
        return; // D·ª´ng h√†m, kh√¥ng ch·∫°y c√°c l·ªánh l∆∞u ph√≠a d∆∞·ªõi
    }

    // N·∫øu c√≥ t√™n, tr·∫£ l·∫°i m√†u vi·ªÅn b√¨nh th∆∞·ªùng (m√†u cam c≈© c·ªßa b·∫°n)
    userNameInput.style.border = "none";
    userNameInput.style.borderBottom = "2px solid var(--border-black)";

    // 2. Ti·∫øp t·ª•c logic l∆∞u nh∆∞ c≈©
    const month = document.getElementById('selMonth').value;
    const year = document.getElementById('selYear').value;
    const key = `${name} - Th√°ng ${month} - ${year}`;
    
    let history = JSON.parse(localStorage.getItem(STORAGE_KEY_HISTORY) || '{}');
    
    if (history[key] && !confirm(`B·∫°n ƒë√£ l∆∞u phi·∫øu cho [${name}] trong th√°ng n√†y r·ªìi. C√≥ mu·ªën ghi ƒë√® kh√¥ng?`)) return;
    
    let d = {};
    document.querySelectorAll('.save').forEach(e => { 
        d[e.id] = (e.type === 'checkbox' ? e.checked : e.value); 
    });
    
    history[key] = d;
    localStorage.setItem(STORAGE_KEY_HISTORY, JSON.stringify(history));
    
    alert(`‚úÖ ƒê√£ l∆∞u th√†nh c√¥ng phi·∫øu l∆∞∆°ng c·ªßa: ${name}`);
    updateHistoryList(); 
    document.getElementById('historySelect').value = key; 
    if(typeof calculateYearTotal === 'function') calculateYearTotal(); 
}

function updateHistoryList() {
    const select = document.getElementById('historySelect');
    const history = JSON.parse(localStorage.getItem(STORAGE_KEY_HISTORY) || '{}');
    
    // Reset danh s√°ch
    select.innerHTML = '<option value="current">-- ƒêang nh·∫≠p --</option>';
    
    // L·∫•y danh s√°ch th√°ng ƒë√£ l∆∞u, s·∫Øp x·∫øp v√† ƒë∆∞a v√†o menu
    Object.keys(history).sort().forEach(key => {
        let opt = document.createElement('option'); 
        opt.value = key; 
        opt.innerText = key;
        select.appendChild(opt);
    });
}

function loadMonthlyData() {
    const select = document.getElementById('historySelect');
    const nameInput = document.getElementById('userName');

    if (select.value === 'current') {
        // Ch·ªâ x√≥a khi ch·ªß ƒë·ªông ch·ªçn d√≤ng "-- ƒêang nh·∫≠p --"
        nameInput.value = "";
        
        // X√≥a tr·∫Øng c√°c √¥ nh·∫≠p li·ªáu s·ªë kh√°c
        document.querySelectorAll('.save').forEach(e => {
            if (e.id !== 'selMonth' && e.id !== 'selYear' && e.id !== 'userName') {
                if (e.type === 'checkbox') e.checked = (e.id === 'chk_pnu');
                else e.value = "";
            }
        });
        calculateAll();
        // Reset t·ªïng nƒÉm v·ªÅ 0 v√¨ t√™n ƒë√£ tr·ªëng
        if (typeof calculateYearTotal === 'function') calculateYearTotal();
        return; 
    }
    
    const history = JSON.parse(localStorage.getItem(STORAGE_KEY_HISTORY) || '{}');
    const data = history[select.value];
    
    if (data) {
        for (let id in data) {
            let e = document.getElementById(id);
            if (e) { 
                if (e.type === 'checkbox') e.checked = data[id]; 
                else e.value = data[id]; 
            }
        }
        calculateAll();
        if (typeof calculateYearTotal === 'function') calculateYearTotal();
    }
}
    function save() {
        const d = {};
        document.querySelectorAll('.save').forEach(e => { d[e.id] = (e.type === 'checkbox' ? e.checked : e.value); });
        localStorage.setItem('salary_gigalane_2025_v6', JSON.stringify(d));
    }

function load() {
    const nameInput = document.getElementById('userName');
    const month = document.getElementById('selMonth').value;
    const year = document.getElementById('selYear').value;
    const historySelect = document.getElementById('historySelect');
    const history = JSON.parse(localStorage.getItem(STORAGE_KEY_HISTORY) || '{}');
    
    // T·ª± ƒë·ªông chuy·ªÉn t√™n ƒëang nh·∫≠p th√†nh CH·ªÆ HOA
    nameInput.value = nameInput.value.toUpperCase();
    let currentName = nameInput.value.trim();
    
    const targetSuffix = `Th√°ng ${month} - ${year}`;

    // 1. Ki·ªÉm tra xem th√°ng/nƒÉm n√†y ƒë√£ c√≥ b·∫•t k·ª≥ d·ªØ li·ªáu c·ªßa ai ch∆∞a
    const allKeysInMonth = Object.keys(history).filter(key => key.endsWith(targetSuffix));

    if (allKeysInMonth.length > 0) {
        // TH1: C√ì D·ªÆ LI·ªÜU TRONG TH√ÅNG N√ÄY (Load d·ªØ li·ªáu c≈©)
        
        const historyKeyWithCurrentName = `${currentName} - ${targetSuffix}`;
        
        // N·∫øu t√™n tr·ªëng ho·∫∑c ng∆∞·ªùi n√†y ch∆∞a c√≥ d·ªØ li·ªáu th√°ng n√†y -> L·∫•y ng∆∞·ªùi ƒë·∫ßu danh s√°ch
        if (!currentName || !history[historyKeyWithCurrentName]) {
            const foundKey = allKeysInMonth[0]; 
            currentName = foundKey.split(" - Th√°ng")[0].toUpperCase();
            nameInput.value = currentName;
        }

        const finalKey = `${currentName} - ${targetSuffix}`;
        if (history[finalKey]) {
            historySelect.value = finalKey;
            const data = history[finalKey];
            for (let id in data) {
                let e = document.getElementById(id);
                if (e) { 
                    if (e.type === 'checkbox') e.checked = data[id]; 
                    else e.value = data[id]; 
                }
            }
        }
    } else {
        // TH2: TH√ÅNG N√ÄY CH∆ØA C√ì D·ªÆ LI·ªÜU (X√≥a s·∫°ch ƒë·ªÉ nh·∫≠p m·ªõi)
        nameInput.value = ""; // X√≥a s·∫°ch t√™n
        historySelect.value = 'current';
        
        document.querySelectorAll('.save').forEach(e => {
            if (e.id !== 'selMonth' && e.id !== 'selYear' && e.id !== 'userName') {
                if (e.type === 'checkbox') {
                    e.checked = (e.id === 'chk_pnu'); 
                } else {
                    e.value = ""; 
                }
            }
        });
    }

    updateCongChuan();
    calculateAll();
    if(typeof calculateYearTotal === 'function') calculateYearTotal();
}

    document.addEventListener('input', (e) => {
        if(e.target.classList.contains('only-num')) e.target.value = e.target.value.replace(/[^0-9]/g, '');
        if(e.target.classList.contains('only-num-dot')) {
            let v = e.target.value.replace(/[^0-9.]/g, '');
            if ((v.match(/\./g) || []).length > 1) v = v.substring(0, v.lastIndexOf("."));
            e.target.value = v;
        }
        if(e.target.classList.contains('money')) {
            let v = e.target.value.replace(/,/g, '');
            if(v) e.target.value = v.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
        }
        calculateAll();
    });

window.onload = () => {
    // 1. Thi·∫øt l·∫≠p ng√†y th√°ng hi·ªán t·∫°i
    const now = new Date();
    document.getElementById('selMonth').value = now.getMonth() + 1;
    document.getElementById('selYear').value = now.getFullYear();

    // 2. C·∫≠p nh·∫≠t danh s√°ch "th·ª±c ƒë∆°n" l·ªãch s·ª≠
    updateHistoryList(); 

    // 3. T√≠nh c√¥ng chu·∫©n cho th√°ng n√†y
    updateCongChuan();

    // 4. T√¨m v√† load d·ªØ li·ªáu n·∫øu th√°ng n√†y ƒë√£ t·ª´ng l∆∞u
    load(); 

    // 5. C·∫≠p nh·∫≠t l∆∞·ª£t truy c·∫≠p (S·ª≠ d·ª•ng b·ªô ƒë·∫øm c√° nh√¢n thay cho API l·ªói)
    let visits = localStorage.getItem('personal_visits') || 0;
    visits++;
    localStorage.setItem('personal_visits', visits);
    document.getElementById('visit_count').innerText = visits;
    cleanOldHistory(); // xo√° c√°c th√°ng kh√¥ng c√≥ t√™n
};
function calculateYearTotal() {
    // N·∫øu ch∆∞a tick v√†o √¥ hi·ªán t·ªïng nƒÉm th√¨ kh√¥ng t√≠nh
    if (!document.getElementById('show_year_total').checked) return;

    const history = JSON.parse(localStorage.getItem(STORAGE_KEY_HISTORY) || '{}');
    const selectedYear = document.getElementById('selYear').value;
    const currentName = document.getElementById('userName').value.trim();
    
    let totalYear = 0;

    // N·∫øu ch∆∞a nh·∫≠p t√™n th√¨ hi·ªÉn th·ªã 0 v√† d·ª´ng
    if (!currentName) {
        document.getElementById('year_total').innerText = "0";
        return;
    }

    for (let key in history) {
        // KI·ªÇM TRA: Kh√≥a ph·∫£i b·∫Øt ƒë·∫ßu b·∫±ng T√™n v√† ch·ª©a ƒë√∫ng NƒÉm ƒëang ch·ªçn
        // V√≠ d·ª• kh√≥a: "Nguy·ªÖn VƒÉn A - Th√°ng 1 - 2026"
        if (key.startsWith(currentName + " -") && key.includes(" - " + selectedYear)) {
            const d = history[key];
            const n = (id) => parseFloat(String(d[id] || '0').replace(/,/g, '')) || 0;

            // B·ªè qua n·∫øu th√°ng ƒë√≥ kh√¥ng c√≥ l∆∞∆°ng c∆° b·∫£n (tr√°nh s·ªë √¢m)
            if (n('luongCB') <= 0) continue;

            const chuan = n('soCongChuan') || 26;
            const thuc = n('soNgayGio') || 0;
            const tile = thuc / chuan;

            // 1. Thu nh·∫≠p theo c√¥ng th·ª±c t·∫ø
            let t1_thuc = 0;
            const list1 = ['luongCB','pccv','pckn','pcat','pcpccc','pcsk','pctn','pcdt','pcno','pcdl','pccc'];
            list1.forEach(id => { t1_thuc += n(id) * tile; });

            // 2. T√≠nh l∆∞∆°ng tƒÉng ca
            const luongTC = n('luongCB') + n('pccv') + n('pckn') + n('pctn') + n('pcsk') + n('pcno');
            const gioTC = luongTC / chuan / 8;
            let t3 = (n('g150')*1.5 + n('g200')*2 + n('g210')*2.1 + n('g200cn')*2 + n('g270')*2.7 + n('g300')*3 + n('g390')*3.9) * gioTC;

            // 3. Kho·∫£n thu kh√°c
            let pnu = d.chk_pnu ? (gioTC * 2.25) : 0;
            let t2 = pnu + n('tk') + n('trenho') + n('phepton') + n('dcluong') + n('th_da') + n('th_khac') + n('pc_an') + n('pc_hoso');

            // 4. C√°c kho·∫£n gi·∫£m tr·ª´
            const bh = (n('luongCB') + n('pccv') + n('pckn') + n('pctn') + n('pcsk')) * 0.105;
            let t4 = bh + 30000 + n('trukhac');

            // T·ªïng th·ª±c lƒ©nh c·ªßa th√°ng ƒë√≥
            totalYear += (t1_thuc + t2 + t3 - t4);
        }
    }
    
    // Hi·ªÉn th·ªã k·∫øt qu·∫£
    document.getElementById('year_total').innerText = fN(totalYear);
}
function toggleYearTotal() {
    const isChecked = document.getElementById('show_year_total').checked;
    const content = document.getElementById('year_total_content');
    const placeholder = document.getElementById('year_total_placeholder');

    if (isChecked) {
        content.style.display = 'flex';      // Hi·ªán s·ªë ti·ªÅn
        placeholder.style.display = 'none';   // ·∫®n ch·ªØ g·ª£i √Ω
        calculateYearTotal();                // T√≠nh to√°n l·∫°i s·ªë li·ªáu cho m·ªõi nh·∫•t
    } else {
        content.style.display = 'none';      // ·∫®n s·ªë ti·ªÅn
        placeholder.style.display = 'inline'; // Hi·ªán ch·ªØ g·ª£i √Ω
    }
}
function updateVisitCount() {
    // S·ª≠ d·ª•ng d·ªãch v·ª• countapi-key (mi·ªÖn ph√≠ v√† kh√¥ng c·∫ßn ƒëƒÉng k√Ω)
    // L∆∞u √Ω: Thay 'gigalane_salary_v6' b·∫±ng m·ªôt c√°i t√™n ri√™ng bi·ªát c·ªßa b·∫°n
    fetch('https://api.countapi.xyz/hit/gigalane_salary_v6/visits')
        .then(res => res.json())
        .then(res => {
            document.getElementById('visit_count').innerText = res.value;
        })
        .catch(err => {
            document.getElementById('visit_count').innerText = "N/A";
        });
}

function deleteMonthlyData() {
    const name = document.getElementById('userName').value.trim() || "Unknow";
    const month = document.getElementById('selMonth').value;
    const year = document.getElementById('selYear').value;
    const key = `${name} - Th√°ng ${month} - ${year}`;
    
    let history = JSON.parse(localStorage.getItem(STORAGE_KEY_HISTORY) || '{}');

    // Ki·ªÉm tra xem c√≥ d·ªØ li·ªáu ƒë·ªÉ xo√° kh√¥ng
    if (!history[key]) {
        alert(`Kh√¥ng t√¨m th·∫•y d·ªØ li·ªáu l∆∞u cho [${key}] ƒë·ªÉ xo√°.`);
        return;
    }

    // X√°c nh·∫≠n l·∫ßn 1
    if (confirm(`B·∫†N C√ì CH·∫ÆC CH·∫ÆN mu·ªën xo√° phi·∫øu l∆∞∆°ng c·ªßa: ${key}?`)) {
        // X√°c nh·∫≠n l·∫ßn 2
        if (confirm(`C·∫¢NH B√ÅO: D·ªØ li·ªáu sau khi xo√° s·∫Ω kh√¥ng th·ªÉ kh√¥i ph·ª•c. B·∫°n v·∫´n mu·ªën xo√° ch·ª©?`)) {
            
            // Th·ª±c hi·ªán xo√°
            delete history[key];
            localStorage.setItem(STORAGE_KEY_HISTORY, JSON.stringify(history));
            
            alert('ƒê√£ xo√° d·ªØ li·ªáu th√†nh c√¥ng.');
            
            // C·∫≠p nh·∫≠t l·∫°i giao di·ªán
            updateHistoryList();
            load(); // Quay v·ªÅ tr·∫°ng th√°i "ƒêang nh·∫≠p" tr·ªëng
            if(typeof calculateYearTotal === 'function') calculateYearTotal();
        }
    }
}
function cleanOldHistory() {
    let history = JSON.parse(localStorage.getItem(STORAGE_KEY_HISTORY) || '{}');
    let newHistory = {};
    let count = 0;
    let hasOldData = false;

    for (let key in history) {
        if (key.includes(" - Th√°ng") && key.split(" - ").length >= 3) {
            newHistory[key] = history[key];
        } else {
            count++;
            hasOldData = true;
        }
    }

    if (hasOldData && count > 0) {
        if (confirm(`T√¨m th·∫•y ${count} b·∫£n l∆∞u c≈© kh√¥ng c√≥ t√™n. B·∫°n c√≥ mu·ªën d·ªçn d·∫πp kh√¥ng?`)) {
            localStorage.setItem(STORAGE_KEY_HISTORY, JSON.stringify(newHistory));
            updateHistoryList();
            load();
        }
    }
}

</script>
</body>
</html>

